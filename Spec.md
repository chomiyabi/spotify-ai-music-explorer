# Spotify データビジュアライゼーション アプリケーション仕様書

## 1. 目的
本アプリケーションは、SpotifyがAPIを通じて提供する膨大な音楽関連データを、専門的な知識がないユーザーでも直感的に理解し、楽しめる形で提供することを目的とします。音楽のトレンドや特定のジャンルの人気曲、アーティスト情報などを簡単な操作で引き出せるようにすることで、データアクセスのハードルを下げます。これにより、ユーザーが新たな音楽を発見したり、音楽への興味関心を深めたりするきっかけを創出することが、このプロジェクトの中心的なゴールです。ユーザーのログインを不要とすることで、誰でも気軽に利用できる手軽さを実現します。

## 2. ハイレベルワークフロー
このアプリケーションには、大きく分けて2つの操作フローが存在します。

### A. プリセットボタンによるデータ取得フロー
あらかじめ定義された人気の検索条件をワンクリックで実行する際のデータの流れです。

```
ユーザー操作（ボタンクリック）
    │
    └───> ① フロントエンド：指定されたリクエストをバックエンドに送信
            │
            └───> ② バックエンド：対応するSpotify APIを呼び出し
                    │
                    └───> ③ Spotify API：データをJSON形式で返却
                            │
                            └───> ④ バックエンド：データをフロントエンド用に整形
                                    │
                                    └───> ⑤ フロントエンド：結果を受け取り画面に表示
```

### B. フリーテキストによるデータ取得フロー
ユーザーが自由に入力した内容をAIが解釈し、最適なデータを表示する際の流れです。

```
ユーザー操作（テキスト入力＆検索）
    │
    └───> ① フロントエンド：入力テキストをバックエンドに送信
            │
            └───> ② バックエンド：テキストをAIサービスに送信
                    │
                    └───> ③ AIサービス (LLM)：テキストを解釈し、検索に適したキーワードやパラメータを生成して返却
                            │
                            └───> ④ バックエンド：AIの返答を元にSpotify APIを呼び出し
                                    │
                                    └───> ⑤ Spotify API：データをJSON形式で返却
                                            │
                                            └───> ⑥ バックエンド：データをフロントエンド用に整形
                                                    │
                                                    └───> ⑦ フロントエンド：結果を受け取り画面に表示
```

### C. AI DJ機能による音声生成フロー
ラジオ風のDJボタンをクリックすることで、その日の人気楽曲を基にAIが生成したオリジナルのDJトークが音声で再生される流れです。

```
ユーザー操作（DJボタンクリック）
    │
    └───> ① フロントエンド：バックエンドにDJ機能の実行をリクエスト
            │
            └───> ② バックエンド：Spotify APIで「日本のバイラルトップ50」を取得
                    │
                    └───> ③ バックエンド：取得データの上位3曲からアーティスト名を抽出し、リクエスト用のJSONを生成
                            │
                            └───> ④ バックエンド：生成したJSONをDify APIへPOSTリクエストで送信
                                    │
                                    └───> ⑤ Dify：リクエストを受け、ワークフローを実行。音声データ（.wav）を生成して返却
                                            │
                                            └───> ⑥ バックエンド：Difyから音声データを受け取る
                                                    │
                                                    └───> ⑦ フロントエンド：バックエンドから音声データを受け取り、自動再生する
```

## 3. システム構成
本アプリケーションの実現に必要となる最低限の技術要素を以下に示します。

| レイヤ | コンポーネント | 主な技術（※補足提案） | 役割 |
|-------|-------------|-------------------|------|
| フロントエンド | UI / APIクライアント | React / Vue.js | ユーザーが操作する画面の描画と、バックエンドとの通信を担当します。 |
| バックエンド | APIサーバー | Node.js (Express) / Python (FastAPI) | フロントエンドからのリクエストを受け付け、外部サービスとの連携やデータ加工を行います。 |
| AI サービス（検索） | 自然言語処理モデル | Claude（※補足提案） | フリーテキストで入力されたユーザーの意図を解釈し、Spotify APIで検索可能な形式に変換します。 |
| AI サービス（DJ） | 音声生成AI | Dify | 楽曲データを元にDJトークを生成し、.wav形式の音声データを返却します。 |
| 認証 | API認証 | Spotify API (Client Credentials Flow)（※補足提案） | ユーザーのログインなしに、アプリケーション自体がSpotifyのデータにアクセスするための認証を行います。 |
| ホスティング/インフラ | 実行環境 | Vercel / Netlify / AWS Amplify（※補足提案） | フロントエンドとサーバーレスなバックエンドを統合的に管理・公開するためのプラットフォームです。 |

## 4. フロントエンド UI
ユーザーが直接触れる主要な画面要素の構成案です。

### ヘッダーエリア
アプリケーションのタイトルと簡単な説明を配置します。

### プリセットボタンエリア
クリックするだけで人気のあるデータが表示されるボタンを10個配置します。（※補足提案）

ボタンの具体例:
- 日本のバイラル Top 50
- 世界の Top 50
- 日本の Top アーティスト 10
- アメリカの Top アーティスト 10
- K-POP ジャンルの人気プレイリスト
- アニメソングの人気プレイリスト
- 最新リリースのアルバム
- 最新リリースのシングル
- 今日のポッドキャストランキング
- ワークアウト向けプレイリスト

### フリーテキスト検索エリア
- **テキスト入力フォーム**: ユーザーが自由に質問やキーワードを入力できる欄。「例：80年代の洋楽ヒット曲」のようなプレースホルダーを表示し、入力を促します。
- **検索ボタン**: 入力された内容で検索を実行します。

### AI DJエリア
ラジオ風のUI要素として、画面上に配置されるDJボタンセクション。

- **DJボタン**：
  - **通常時**: レトロなラジオのチューニングダイヤルや光沢のあるマイクをモチーフにしたデザイン。ボタン周りに微かなグロー効果で操作可能性を示唆
  - **処理中**: 回転するレコードや揺れるイコライザーアニメーションで音声生成中を表現
  - **再生中**: 音声の波形を表示するビジュアライザーに変化し、停止ボタンとしても機能

機能詳細：
- クリックすると「日本のバイラルトップ50」の上位3曲データを取得
- 取得したアーティスト名をDify APIに送信してAI DJトークを生成
- 生成された.wav音声を自動再生
- 再生中は停止操作が可能

### 結果表示エリア
- 初期状態では、アプリケーションの使い方のガイドなどを表示します。
- ボタンクリックや検索実行後、取得したデータ（楽曲リスト、アーティストリスト、アルバムリストなど）がここに表示されます。

（※補足提案）表示形式:
- 各項目はカード形式で表示し、ジャケット写真、曲名、アーティスト名、アルバム名を記載します。
- 各カードには、クリックするとSpotifyの公式ページやアプリでその曲を聴ける外部リンクを設置します。
- リストには順位番号を付け、ランキング形式で分かりやすく見せます。

## 5. AI DJ機能 - API仕様詳細

### 5.1 データフォーマット
バックエンドがSpotifyから「日本のバイラルトップ50」のデータを取得後、Dify APIへ送信するために上位3曲のアーティスト名をカンマ区切りの単一文字列に整形します。

**生成する文字列の例:**
```
"YOASOBI, Ado, Vaundy"
```

### 5.2 Dify API リクエスト仕様

**Method:** POST  
**Endpoint:** `https://api.dify.ai/v1/workflows/run`

**Headers:**
```
Content-Type: application/json
Authorization: Bearer app-7NbhsYDF9wP0trIPIO5EYlEo
```

**Request Body:**
```json
{
  "inputs": {
    "ArtistName": "（1位のアーティスト名）, （2位のアーティスト名）, （3位のアーティスト名）",
    "sys.files": [],
    "sys.user_id": "581bf1bd-d0db-46f7-ac58-d3c1776573a7",
    "sys.app_id": "219ce180-beb8-4b1c-a726-0eb5f2808d45",
    "sys.workflow_id": "f61cb5b5-6760-40bb-8dfd-2a58fa70e3d8",
    "sys.workflow_run_id": "ff08ecb1-f1de-4ef3-b776-5b1f0c16f7c6"
  },
  "response_mode": "blocking",
  "user": "abc-123"
}
```

**パラメータ説明:**
- `inputs.ArtistName`: バックエンドで動的に生成するカンマ区切りのアーティスト名文字列
- その他の`sys.`から始まるキーや`user`キーは、Difyの仕様に基づいた固定値または環境に応じた値

### 5.3 Dify API レスポンス仕様

**データ形式:** wav形式の音声データ

**フロントエンドでの処理:**
- バックエンド経由で音声データを受け取り後、即座に自動再生開始
- 再生完了またはユーザーの停止ボタン押下まで再生継続

## 6. アーティスト最新情報ニュースレター機能

### 6.1 機能概要
ユーザーが指定した国のトップアーティストの最新情報を、ニュースレターとして定期的にメールで受け取ることができる機能です。ユーザーは簡単な操作で、興味のある地域の音楽シーンの動向を追い続けることが可能になります。

### 6.2 UI/UX
アプリケーションのフロントエンドに、以下の要素で構成される「トップアーティストの最新情報を購読」セクションを新たに追加します。

#### UI要素:
1. **国名選択ドロップダウン**:
   - ニュースレターの対象となる国を選択
   - 選択肢には、Spotify APIが市場としてデータを提供している国（日本、アメリカ、イギリスなど）のリストを表示

2. **メールアドレス入力欄**:
   - ニュースレターの配信先となるメールアドレスをユーザーが入力
   - `example@email.com` のようなプレースホルダーを表示

3. **購読ボタン**:
   - 「最新情報を得る」というラベルのボタンを配置
   - クリック後、処理が正常に受け付けられたことを示すメッセージを表示

4. **完了メッセージ**:
   - ボタンをクリックすると、ボタンの下に「メールボックスをチェックしてください」というメッセージが表示

### 6.3 システム連携フロー
ユーザーがボタンをクリックしてから、n8nのワークフローが起動されるまでの一連の流れです。

```
ユーザー操作（国選択 & メールアドレス入力）
    │
    └───> ① フロントエンド：「最新情報を得る」ボタンをクリック
            │
            └───> ② バックエンド：Spotify APIで選択された国のトップアーティストを取得
                    │
                    └───> ③ バックエンド：取得したアーティスト情報とメールアドレスをn8n Webhookへ送信
                            │
                            └───> ④ n8n Webhook：リクエスト受信後、後続の処理を開始
                                    │
                                    └───> ⑤ フロントエンド：完了メッセージ「メールボックスをチェックしてください」を表示
```

### 6.4 API仕様詳細

#### 6.4.1 トップアーティスト取得
バックエンドは、Spotify APIを利用して、ユーザーが選択した国のトップアーティスト（1名）の情報を取得します。

#### 6.4.2 n8n Webhook連携
バックエンドは、取得したアーティスト名とユーザーが入力したメールアドレスを、以下の形式でn8nのWebhook URLにHTTPリクエストとして送信します。

**Method:** GET または POST

**Endpoint:**
```
https://chomiyabi.app.n8n.cloud/webhook/4447ccd3-c50b-4d48-945b-187ad677002a
```

**パラメータ:**
- `p`: URLエンコードされたアーティスト名
- `mail`: ユーザーのメールアドレス

**リクエスト例:**
```
GET https://chomiyabi.app.n8n.cloud/webhook/4447ccd3-c50b-4d48-945b-187ad677002a?p=YOASOBI&mail=user@example.com
```

### 6.5 実装要件

#### フロントエンド要件:
- 国選択ドロップダウンは、Spotify APIがサポートする市場リストを動的に取得して表示
- メールアドレスのバリデーション（適切な形式チェック）
- ボタンクリック後のローディング状態の表示
- エラーハンドリング（API失敗時のユーザーフィードバック）

#### バックエンド要件:
- 選択された国コードに基づくSpotify APIの適切な呼び出し
- アーティスト名のURLエンコーディング処理
- n8n Webhookへのリクエスト送信とレスポンス処理
- エラーハンドリングとリトライロジック

#### セキュリティ考慮事項:
- メールアドレスの適切な検証
- レート制限の実装（同一IPからの過度なリクエストを防止）
- n8n Webhook URLの環境変数での管理
- XSS対策のための入力値サニタイゼーション